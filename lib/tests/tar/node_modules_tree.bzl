# https://github.com/bazelbuild/rules_pkg/pull/609
"""
This rule creates a tree of files and directories that represents a node_modules
"""

def _impl(ctx):
    # packages
    # - a
    # - b depends on a
    store_a = ctx.actions.declare_directory("node_modules/.pnpm/a@0.0.0/node_modules/a")
    store_b = ctx.actions.declare_directory("node_modules/.pnpm/b@0.0.0/node_modules/b")

    ctx.actions.run_shell(
        outputs = [store_a, store_b],
        command = "echo 'test' > %s/package.json" % store_a.path,
    )

    dep_symlink_b_to_a = ctx.actions.declare_directory("node_modules/.pnpm/b@0.0.0/node_modules/a")

    ctx.actions.symlink(
        output = dep_symlink_b_to_a,
        target_file = store_a,
    )

    node_modules_a = ctx.actions.declare_directory("node_modules/a")
    ctx.actions.symlink(
        output = node_modules_a,
        target_file = store_a,
    )

    # single file
    a = ctx.actions.declare_file("dir/a")
    ctx.actions.run_shell(
        outputs = [a],
        command = "echo 'test' > %s" % a.path,
    )

    b = ctx.actions.declare_file("dir/b")
    ctx.actions.symlink(
        output = b,
        target_file = a,
    )

    return DefaultInfo(files = depset([
        store_a,
        store_b,
        dep_symlink_b_to_a,
        node_modules_a,
        a,
        b,
    ]))

node_modules_tree = rule(
    implementation = _impl,
)
